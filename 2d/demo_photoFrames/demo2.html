<head>
<meta charset="utf-8">
</head>

<body>
<script type="text/javascript" src="../../wgeCore.js"></script>
<script type="text/javascript" src="../../wgeVector.js"></script>
<script type="text/javascript" src="../wgeSprite.js"></script>
<script type="text/javascript" src="../wgeAnimation.js"></script>
<script type="text/javascript" src="../wgeFilters.js"></script>
<script type="text/javascript" src="photoFrames.js"></script>

<canvas id="photoFrames" width='800' height='600' style="border:groove;background-color:#000">你的浏览器不支持html5，换一个再来！(推荐：Chrome, Firefox, Safari)</canvas><br>
<input type="button" value="MUTE or not" onclick="var snd = WGE.ID('bgSound'); snd.muted=!snd.muted">
<input type="button" value="点击查看另一个版本" onclick="window.location='index.html'">
<br>
<p>本页面使用html5编写，如果您使用的是IE，请保证IE版本>=9。如果图片过多导致加载失败，请刷新界面</p>

<script type="text/javascript">
"use strict";
var timeline = new WGE.TimeLine(60000);
var cvs = WGE.ID('photoFrames');
var ctx = cvs.getContext('2d');
var totalImages = 12;
var loadedImages = 0;
var lastTime = 0;

ctx.font = "50px Aria";

ctx.fillStyle = "#0f0";

if(!window.requestAnimationFrame)
{
	window.requestAnimationFrame = window.mozRequestAnimationFrame ||
							window.webkitRequestAnimationFrame ||
							window.msRequestAnimationFrame ||
							window.oRequestAnimationFrame ||
							function(callback) {
								setTimeout(callback, 1000 / 60);
							};
}

function scaleImage(img)
{
	if(!img.width)
	{
		img.width = 800;
		img.height = 600;
	}

	var c = WGE.CE('canvas');
	c.width = img.width * (720.0 / img.height);
	c.height = 720;
	var t = c.getContext('2d');
	t.save();
	t.scale(c.width / img.width, c.height / img.height);
	t.drawImage(img, 0, 0);
	t.restore();
	return c;
}

function main()
{
	ctx.fillStyle = "#000";
	ctx.strokeStyle = "#fff";
	ctx.lineWidth = 6;

	var imgArray = [];
	for(var i = 0; i != totalImages; ++i)
	{
		var img = scaleImage(WGE.ID("test" + i));
		imgArray.push(img);
	}

	var timeStamp = 0, stillTime = 17000, globalZ = 0;
	for(var j = 0; j != 4; ++j)
	{
		var scene = FTPhotoFrame.initScene(imgArray, 800, 600, globalZ, timeStamp, stillTime);
		timeline.pushArr(scene);
		globalZ += 10000;
		timeStamp += 15000;
	}

	timeline.start(0);
	lastTime = Date.now();
	WGE.ID('bgSound').play();
	mainloop();
}

function endloop()
{
	ctx.fillRect(0,0, 800, 600);
	ctx.globalAlpha += 0.01;
	if(ctx.globalAlpha >= 0.99)
	{
		ctx.fillStyle = "#fff";
		ctx.fillText("The End.", 200, cvs.height / 2);
		ctx.font = "30px Aria";
		ctx.fillText("By wysaid", 400, 400);
		return ;
	}
	requestAnimationFrame(endloop);
}

function mainloop()
{
	var timeNow = Date.now();
    
	if(!timeline.update(timeNow - lastTime))
	{
	    console.log('PhotoFrames End');
	    ctx.globalAlpha = 0.001;
	    ctx.fillStyle = "#000";
	    requestAnimationFrame(endloop);
		return ;
	}
	lastTime = timeNow;
	ctx.clearRect(0,0, 800, 600);
	timeline.render(ctx);
	requestAnimationFrame(mainloop);
}

function loadingDone()
{
	++loadedImages;
	if(loadedImages == totalImages)
	{
		ctx.clearRect(0,0, 800, 600);
		ctx.fillText("初始化场景......", 10, cvs.height / 2);
		setTimeout("main()", 100);
		return ;
	}

	var loadedRate = loadedImages / totalImages * 100;

	ctx.clearRect(0,0, 800, 600);
	ctx.fillText("LoadingImages: " + loadedRate.toFixed(2) + "%", 10, cvs.height / 2);
}

</script>


<div style="display:none">
<img src="../../res/0.jpg" id="test0" onload="loadingDone()">
<img src="../../res/1.jpg" id="test1" onload="loadingDone()">
<img src="../../res/2.jpg" id="test2" onload="loadingDone()">
<img src="../../res/3.jpg" id="test3" onload="loadingDone()">
<img src="../../res/4.jpg" id="test4" onload="loadingDone()">
<img src="../../res/5.jpg" id="test5" onload="loadingDone()">
<img src="../../res/6.jpg" id="test6" onload="loadingDone()">
<img src="../../res/7.jpg" id="test7" onload="loadingDone()">
<img src="../../res/8.jpg" id="test8" onload="loadingDone()">
<img src="../../res/9.jpg" id="test9" onload="loadingDone()">
<img src="../../res/10.jpg" id="test10" onload="loadingDone()">
<img src="../../res/11.jpg" id="test11" onload="loadingDone()">
<audio src="../../res/snd1.mp3" id="bgSound"></audio>
</div>

</body>